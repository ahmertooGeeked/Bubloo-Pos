{% extends 'pos/base.html' %}

{% block content %}
<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">

        <div class="col-md-8 col-lg-8 h-100 d-flex flex-column position-relative" style="min-width: 0;">

            <div class="sticky-top bg-light border-bottom shadow-sm px-4 pt-3 pb-2" style="z-index: 100;">

                <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">

                    <div class="d-flex align-items-center gap-3">
                        <div>
                            <h2 class="fw-bold text-dark m-0 lh-1">Bubloo Ki Sajji</h2>
                            <p class="text-muted small m-0">POS System â€¢ <span id="current-date"></span></p>
                        </div>

                        <div class="d-none d-md-flex gap-2">
                            <a href="/kitchen/" target="_blank" class="btn btn-white border shadow-sm btn-sm rounded-pill px-3 fw-bold text-secondary text-decoration-none">
                                <i class="fa-solid fa-fire-burner me-2 text-danger"></i>Kitchen
                            </a>
                            <a href="/tables/" class="btn btn-white border shadow-sm btn-sm rounded-pill px-3 fw-bold text-secondary text-decoration-none">
                                <i class="fa-solid fa-user-tie me-2 text-primary"></i>Manager
                            </a>
                        </div>
                    </div>

                    <div class="flex-grow-1" style="max-width: 300px;">
                        <div class="input-group shadow-sm rounded-pill bg-white">
                            <span class="input-group-text bg-white border-0 ps-3"><i class="fa fa-search text-muted"></i></span>
                            <input type="text" id="search-input" class="form-control border-0 bg-transparent shadow-none" placeholder="Search menu..." onkeyup="filterMenu()">
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 overflow-auto pb-2" style="scrollbar-width: none;">
                    <button class="btn btn-dark rounded-pill px-4 fw-bold flex-shrink-0 shadow-sm" onclick="filterCategory('all')">
                        <i class="fa-solid fa-utensils me-2"></i>All Menu
                    </button>

                    {% for cat in categories %}
                    <button class="btn btn-white bg-white border shadow-sm text-secondary rounded-pill px-4 fw-bold flex-shrink-0" onclick="filterCategory('{{ cat.id }}')">
                        {{ cat.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div class="flex-grow-1 overflow-auto p-4 bg-light">
                <div class="row g-3" id="menu-grid">
                    {% for item in menu_items %}
                    <div class="col-md-4 col-lg-3 menu-item-card" data-category="{{ item.category.id }}" data-name="{{ item.name|lower }}">
                        <div class="card h-100 border-0 shadow-sm rounded-4 position-relative"
                             onclick="addToCart({{ item.id }}, '{{ item.name|escapejs }}', {{ item.price }})"
                             style="cursor: pointer; transition: transform 0.2s;">

                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center rounded-top-4" style="height: 140px;">
                                {% if item.image %}
                                    <img src="{{ item.image.url }}" class="w-100 h-100 object-fit-cover rounded-top-4">
                                {% else %}
                                    <i class="fa-solid fa-burger fa-3x text-secondary opacity-25"></i>
                                {% endif %}
                            </div>

                            <div class="card-body p-3">
                                <h6 class="fw-bold text-dark mb-1 text-truncate">{{ item.name }}</h6>
                                <p class="text-muted small mb-2">{{ item.category.name }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-primary">Rs. {{ item.price }}</span>
                                    <button class="btn btn-sm btn-light text-primary rounded-circle"><i class="fa fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-4 col-lg-4 bg-white h-100 shadow-lg d-flex flex-column p-4" style="z-index: 200;">

            <h4 class="fw-bold mb-3">Order Details</h4>

            <ul class="nav nav-pills nav-fill mb-3 p-1 bg-light rounded-pill">
                <li class="nav-item">
                    <a class="nav-link active rounded-pill fw-bold" id="tab-dine-in" onclick="setOrderType('dine-in')" href="#">
                        <i class="fa-solid fa-chair me-2"></i>Dine-in
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-pill fw-bold text-muted" id="tab-takeaway" onclick="setOrderType('takeaway')" href="#">
                        <i class="fa-solid fa-bag-shopping me-2"></i>Takeaway
                    </a>
                </li>
            </ul>

            <div class="mb-3">
                <div class="mb-3">
                    <label class="small text-muted fw-bold mb-1">Customer Details</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="text" id="cust-name" class="form-control bg-light border-0 fw-bold" placeholder="Name (e.g. Ali)">
                        </div>
                        <div class="col-6">
                            <input type="text" id="cust-phone" class="form-control bg-light border-0 fw-bold" placeholder="Phone (Optional)">
                        </div>
                    </div>
                </div>

                <div id="dine-in-options">
                    <label class="small text-muted fw-bold mb-1">Select Table</label>
                    <select id="selected-table" class="form-select border-0 bg-light rounded-3 py-2 fw-bold text-primary">
                        <option value="" selected disabled>Choose Table...</option>
                        {% for table in tables %}
                            <option value="{{ table.id }}">{{ table.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div id="cart-items-container" class="flex-grow-1 bg-light rounded-4 p-3 d-flex flex-column overflow-auto no-scrollbar mb-3">
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                    <i class="fa-solid fa-basket-shopping fa-3x opacity-25 mb-3"></i>
                    <h6>No items selected</h6>
                </div>
            </div>

            <div class="border-top pt-3">

                <div class="mb-3">
                    <label class="small text-muted fw-bold mb-2">Payment Method</label>
                    <div class="d-flex gap-2">
                        <input type="radio" class="btn-check" name="paymethod" id="pay-cash" value="cash" checked onchange="togglePaymentInput()">
                        <label class="btn btn-outline-success flex-grow-1 fw-bold rounded-pill" for="pay-cash">
                            <i class="fa-solid fa-money-bill me-2"></i>Cash
                        </label>

                        <input type="radio" class="btn-check" name="paymethod" id="pay-card" value="card" onchange="togglePaymentInput()">
                        <label class="btn btn-outline-primary flex-grow-1 fw-bold rounded-pill" for="pay-card">
                            <i class="fa-solid fa-credit-card me-2"></i>Card
                        </label>
                    </div>
                </div>

                <div class="mb-3" id="cash-input-section">
                    <label class="small text-muted fw-bold">Cash Received</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0">Rs.</span>
                        <input type="number" id="cash-input" class="form-control bg-light border-0 fw-bold" placeholder="0" onkeyup="calculateChange()">
                    </div>
                    <div class="d-flex justify-content-between mt-2 px-1">
                        <small class="text-muted">Change Due:</small>
                        <small class="fw-bold text-success" id="change-display">Rs. 0.00</small>
                    </div>
                </div>

                <div class="d-flex justify-content-between mb-4">
                    <span class="fs-4 fw-bold text-dark">Total</span>
                    <span class="fs-4 fw-bold text-primary" id="cart-total">Rs. 0.00</span>
                </div>
                <div class="d-grid gap-2">
                    <button onclick="placeOrder()" class="btn btn-primary btn-lg rounded-3 fw-bold py-3 shadow-sm">
                        Place Order
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let cart = [];
    let currentOrderType = 'dine-in';

    // --- 1. SWITCH ORDER TYPE ---
    function setOrderType(type) {
        currentOrderType = type;
        if(type === 'dine-in') {
            document.getElementById('tab-dine-in').classList.add('active', 'bg-white', 'shadow-sm');
            document.getElementById('tab-takeaway').classList.remove('active', 'bg-white', 'shadow-sm');
            document.getElementById('tab-takeaway').classList.add('text-muted');
            document.getElementById('dine-in-options').style.display = 'block';
        } else {
            document.getElementById('tab-takeaway').classList.add('active', 'bg-white', 'shadow-sm');
            document.getElementById('tab-takeaway').classList.remove('text-muted');
            document.getElementById('tab-dine-in').classList.remove('active', 'bg-white', 'shadow-sm');
            document.getElementById('dine-in-options').style.display = 'none';
        }
    }

    // --- 2. PAYMENT TOGGLE LOGIC ---
    function togglePaymentInput() {
        const isCash = document.getElementById('pay-cash').checked;
        const cashSection = document.getElementById('cash-input-section');

        if (isCash) {
            cashSection.style.display = 'block';
        } else {
            cashSection.style.display = 'none';
        }
    }

    // --- 3. LIVE CHANGE CALCULATOR ---
    function calculateChange() {
        const cash = parseFloat(document.getElementById('cash-input').value) || 0;
        const totalText = document.getElementById('cart-total').innerText.replace('Rs. ', '');
        const total = parseFloat(totalText) || 0;

        const change = cash - total;
        const display = document.getElementById('change-display');

        display.innerText = `Rs. ${change.toFixed(2)}`;

        if(change < 0) {
            display.classList.remove('text-success');
            display.classList.add('text-danger');
        } else {
            display.classList.remove('text-danger');
            display.classList.add('text-success');
        }
    }

    // --- 4. PLACE ORDER LOGIC ---
    function placeOrder() {
        if (cart.length === 0) { alert("Cart is empty!"); return; }

        const name = document.getElementById('cust-name').value;
        const phone = document.getElementById('cust-phone').value;
        const cashGiven = document.getElementById('cash-input').value;

        // Get selected payment method
        const paymentMethod = document.querySelector('input[name="paymethod"]:checked').value;

        let payload = {
            cart: cart,
            order_type: currentOrderType,
            payment_method: paymentMethod, // <--- Sent to server
            customer_name: name,
            customer_phone: phone,
            cash_given: cashGiven
        };

        if (currentOrderType === 'dine-in') {
            const tableId = document.getElementById('selected-table').value;
            if (!tableId) { alert("Please select a table!"); return; }
            payload.table_id = tableId;
        } else {
            if (!name) { alert("Please enter Customer Name for Takeaway!"); return; }
        }

        fetch('/place-order/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = `/order-success/${data.order_id}/`;
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Something went wrong!");
        });
    }

    // --- 5. CART FUNCTIONS ---
    function addToCart(id, name, price) {
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) { existingItem.quantity += 1; }
        else { cart.push({ id: id, name: name, price: price, quantity: 1 }); }
        renderCart();
    }

    function updateQuantity(id, change) {
        const item = cart.find(item => item.id === id);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) { cart = cart.filter(i => i.id !== id); }
        }
        renderCart();
    }

    function renderCart() {
        const container = document.getElementById('cart-items-container');
        const totalEl = document.getElementById('cart-total');
        container.innerHTML = '';
        let subtotal = 0;

        if (cart.length === 0) {
            container.innerHTML = `<div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted"><i class="fa-solid fa-basket-shopping fa-3x opacity-25 mb-3"></i><h6>No items selected</h6></div>`;
        } else {
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                container.innerHTML += `
                <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-white rounded-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;"><span class="fw-bold text-primary">${item.quantity}x</span></div>
                        <div><h6 class="mb-0 fw-bold text-dark text-truncate" style="max-width: 120px;">${item.name}</h6><small class="text-muted">Rs. ${item.price}</small></div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="fw-bold me-3">Rs. ${itemTotal}</span>
                        <div class="btn-group btn-group-sm"><button onclick="updateQuantity(${item.id}, -1)" class="btn btn-light text-danger"><i class="fa fa-minus"></i></button><button onclick="updateQuantity(${item.id}, 1)" class="btn btn-light text-success"><i class="fa fa-plus"></i></button></div>
                    </div>
                </div>`;
            });
        }
        totalEl.innerText = `Rs. ${subtotal.toFixed(2)}`;
        calculateChange();
    }

    // Filter functions
    function filterCategory(catId) {
        document.querySelectorAll('.menu-item-card').forEach(item => {
            item.style.display = (catId === 'all' || item.getAttribute('data-category') === catId) ? 'block' : 'none';
        });
    }
    function filterMenu() {
        const search = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('.menu-item-card').forEach(item => {
            item.style.display = item.getAttribute('data-name').includes(search) ? 'block' : 'none';
        });
    }

    document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
</script>
{% endblock %}
