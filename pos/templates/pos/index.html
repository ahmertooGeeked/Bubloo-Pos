{% extends 'pos/base.html' %}

{% block content %}
<div class="container-fluid h-100 p-0">
    <div class="row g-0 h-100">

        <div class="col-md-8 col-lg-8 h-100 d-flex flex-column p-4" style="min-width: 0;">

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-dark m-0">Bubloo Ki Sajji</h2>
                    <p class="text-muted small m-0">POS System â€¢ <span id="current-date"></span></p>
                </div>
                <div class="bg-white p-2 rounded-4 shadow-sm" style="width: 300px;">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-0"><i class="fa fa-search text-muted"></i></span>
                        <input type="text" id="search-input" class="form-control border-0 bg-transparent shadow-none" placeholder="Search menu..." onkeyup="filterMenu()">
                    </div>
                </div>
            </div>

            <div class="d-flex gap-3 mb-4 overflow-auto no-scrollbar pb-2 align-items-center">
                <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm"
                        onclick="filterCategory('all')"
                        style="white-space: nowrap; flex-shrink: 0;">
                    <i class="fa-solid fa-utensils me-2"></i>All Menu
                </button>

                {% for cat in categories %}
                <button class="btn btn-white bg-white border-0 text-secondary rounded-pill px-4 fw-bold shadow-sm"
                        onclick="filterCategory('{{ cat.id }}')"
                        style="white-space: nowrap; flex-shrink: 0;">
                    {{ cat.name }}
                </button>
                {% endfor %}
            </div>

            <div class="flex-grow-1 overflow-auto no-scrollbar pe-2">
                <div class="row g-3" id="menu-grid">
                    {% for item in menu_items %}
                    <div class="col-md-4 col-lg-3 menu-item-card" data-category="{{ item.category.id }}" data-name="{{ item.name|lower }}">
                        <div class="card h-100 border-0 shadow-sm rounded-4"
                             onclick="addToCart({{ item.id }}, '{{ item.name|escapejs }}', {{ item.price }})"
                             style="cursor: pointer; transition: transform 0.2s;">

                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center rounded-top-4" style="height: 140px;">
                                {% if item.image %}
                                    <img src="{{ item.image.url }}" class="w-100 h-100 object-fit-cover rounded-top-4">
                                {% else %}
                                    <i class="fa-solid fa-burger fa-3x text-secondary opacity-25"></i>
                                {% endif %}
                            </div>

                            <div class="card-body p-3">
                                <h6 class="fw-bold text-dark mb-1 text-truncate">{{ item.name }}</h6>
                                <p class="text-muted small mb-2">{{ item.category.name }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-primary">Rs. {{ item.price }}</span>
                                    <button class="btn btn-sm btn-light text-primary rounded-circle">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-4 col-lg-4 bg-white h-100 shadow-lg d-flex flex-column p-4" style="z-index: 10;">

            <div class="mb-4">
                <h4 class="fw-bold mb-3">Order Details</h4>
                <div class="row g-2">
                    <div class="col-6">
                        <select class="form-select border-0 bg-light rounded-3 py-2 fw-bold text-secondary">
                            <option selected>Walk-in Customer</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <select id="selected-table" class="form-select border-0 bg-light rounded-3 py-2 fw-bold text-primary">
                            <option value="" selected disabled>Select Table</option>
                            {% for table in tables %}
                                <option value="{{ table.id }}">{{ table.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div id="cart-items-container" class="flex-grow-1 bg-light rounded-4 p-3 d-flex flex-column overflow-auto no-scrollbar mb-3">
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                    <i class="fa-solid fa-basket-shopping fa-3x opacity-25 mb-3"></i>
                    <h6>No items selected</h6>
                </div>
            </div>

            <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Subtotal</span>
                    <span class="fw-bold" id="cart-subtotal">Rs. 0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Tax (0%)</span>
                    <span class="fw-bold">Rs. 0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-4">
                    <span class="fs-4 fw-bold text-dark">Total</span>
                    <span class="fs-4 fw-bold text-primary" id="cart-total">Rs. 0.00</span>
                </div>

                <div class="d-grid gap-2">
                    <button onclick="placeOrder()" class="btn btn-primary btn-lg rounded-3 fw-bold py-3 shadow-sm">
                        Place Order
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // 1. STATE MANAGEMENT
    let cart = [];

    // 2. ADD TO CART FUNCTION
    function addToCart(id, name, price) {
        // Check if item already exists in cart
        const existingItem = cart.find(item => item.id === id);

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({ id: id, name: name, price: price, quantity: 1 });
        }
        renderCart();
    }

    // 3. CHANGE QUANTITY (+/-)
    function updateQuantity(id, change) {
        const item = cart.find(item => item.id === id);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                cart = cart.filter(i => i.id !== id);
            }
        }
        renderCart();
    }

    // 4. RENDER UI
    function renderCart() {
        const container = document.getElementById('cart-items-container');
        const subtotalEl = document.getElementById('cart-subtotal');
        const totalEl = document.getElementById('cart-total');

        container.innerHTML = '';
        let subtotal = 0;

        if (cart.length === 0) {
            container.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                    <i class="fa-solid fa-basket-shopping fa-3x opacity-25 mb-3"></i>
                    <h6>No items selected</h6>
                </div>`;
        } else {
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                const html = `
                <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-white rounded-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <span class="fw-bold text-primary">${item.quantity}x</span>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark text-truncate" style="max-width: 120px;">${item.name}</h6>
                            <small class="text-muted">Rs. ${item.price}</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="fw-bold me-3">Rs. ${itemTotal}</span>
                        <div class="btn-group btn-group-sm">
                            <button onclick="updateQuantity(${item.id}, -1)" class="btn btn-light text-danger"><i class="fa fa-minus"></i></button>
                            <button onclick="updateQuantity(${item.id}, 1)" class="btn btn-light text-success"><i class="fa fa-plus"></i></button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        subtotalEl.innerText = `Rs. ${subtotal.toFixed(2)}`;
        totalEl.innerText = `Rs. ${subtotal.toFixed(2)}`;
    }

    // 5. FILTER CATEGORIES
    function filterCategory(catId) {
        const items = document.querySelectorAll('.menu-item-card');
        items.forEach(item => {
            if (catId === 'all' || item.getAttribute('data-category') === catId) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // 6. SEARCH FUNCTION
    function filterMenu() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const items = document.querySelectorAll('.menu-item-card');
        items.forEach(item => {
            const name = item.getAttribute('data-name');
            if (name.includes(search)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // 7. PLACE ORDER (CONNECTED TO DJANGO)
    function placeOrder() {
        if (cart.length === 0) {
            alert("Cart is empty!");
            return;
        }
        const tableId = document.getElementById('selected-table').value;
        if (!tableId) {
            alert("Please select a table first!");
            return;
        }

        // Send Data to Backend
        fetch('/place-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                table_id: tableId,
                cart: cart
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`Order #${data.order_id} placed successfully!`);
                cart = []; // Clear cart
                renderCart(); // Clear UI
                location.reload(); // Reloads page to show table as occupied
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Something went wrong!");
        });
    }

    // Set Date
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', dateOptions);
</script>
{% endblock %}
