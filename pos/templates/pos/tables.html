{% extends 'pos/base.html' %}
{% block title %}Manager Dashboard - Bubloo POS{% endblock %}

{% block content %}
<div class="container-fluid p-4 h-100 overflow-hidden">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold text-dark m-0"><i class="fa-solid fa-layer-group text-primary me-3"></i>Manager Dashboard</h1>
            <p class="text-muted small m-0">Live Floor Plan & Active Orders</p>
        </div>
        <a href="/" class="btn btn-white border shadow-sm rounded-pill px-4 fw-bold text-decoration-none text-dark">
            <i class="fa-solid fa-cash-register me-2"></i>Back to POS
        </a>
    </div>

    <div class="row h-100 pb-5">

        <div class="col-md-9 h-100 overflow-auto no-scrollbar pe-4">
            <h5 class="fw-bold text-muted mb-3">Dine-in Tables</h5>

            <div class="row g-4">
                {% for item in tables %}
                <div class="col-md-3">
                    <div class="card h-100 border-0 shadow-sm rounded-4 text-center position-relative overflow-hidden
                         {% if item.obj.status == 'occupied' %} table-occupied {% else %} table-available {% endif %}">

                        <div class="card-body py-4 d-flex flex-column align-items-center justify-content-between">
                            <h5 class="fw-bold m-0 text-dark">{{ item.obj.name }}</h5>

                            {% if item.obj.status == 'occupied' %}
                                {% if item.active_order %}
                                    <h6 class="fw-bold text-danger mt-3">Rs. {{ item.active_order.total_amount }}</h6>
                                    <small class="text-muted mb-3">{{ item.active_order.customer_name|default:"Guest" }}</small>

                                    <a href="/bill/{{ item.active_order.id }}/" target="_blank" class="btn btn-secondary btn-sm rounded-pill w-100 mb-2 fw-bold">
                                        <i class="fa-solid fa-print me-2"></i>Print Bill
                                    </a>

                                    <button onclick="checkoutTable({{ item.obj.id }})" class="btn btn-outline-danger btn-sm rounded-pill w-100 fw-bold mb-2">
                                        Settle Bill
                                    </button>

                                    <button onclick="cancelOrder({{ item.active_order.id }})" class="btn btn-light text-danger btn-sm rounded-pill w-100 fw-bold border">
                                        <i class="fa-solid fa-trash me-2"></i>Void Order
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-success mt-3 rounded-pill">Available</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-3 h-100 bg-white rounded-4 shadow-sm p-0 d-flex flex-column border">
            <div class="p-3 border-bottom bg-light rounded-top-4">
                <h5 class="fw-bold m-0"><i class="fa-solid fa-bag-shopping me-2 text-primary"></i>Takeaways</h5>
                <small class="text-muted">{{ takeaways.count }} Pending Payment</small>
            </div>

            <div class="flex-grow-1 overflow-auto p-3">
                {% for order in takeaways %}
                <div class="card border-0 shadow-sm mb-3 bg-light">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold text-dark">{{ order.customer_name }}</span>
                            <span class="badge bg-warning text-dark">#{{ order.id }}</span>
                        </div>
                        <h5 class="fw-bold text-primary mb-3">Rs. {{ order.total_amount }}</h5>

                        <a href="/bill/{{ order.id }}/" target="_blank" class="btn btn-outline-dark w-100 btn-sm rounded-pill mb-2">
                            <i class="fa-solid fa-print me-2"></i>Print Receipt
                        </a>

                        <button onclick="settleOrder({{ order.id }})" class="btn btn-dark w-100 btn-sm rounded-pill mb-2">
                            <i class="fa-solid fa-money-bill-wave me-2"></i>Collect Cash
                        </button>

                        <button onclick="cancelOrder({{ order.id }})" class="btn btn-light text-danger w-100 btn-sm rounded-pill border">
                            <i class="fa-solid fa-trash me-2"></i>Void
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted mt-5 opacity-50">
                    <i class="fa-solid fa-check-circle fa-3x mb-3"></i>
                    <p>No active takeaways</p>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<style>
    .table-available { border-bottom: 5px solid #198754 !important; }
    .table-occupied { border-bottom: 5px solid #dc3545 !important; background-color: #fff8f8; }
</style>

<script>
    // 1. DINE-IN CHECKOUT
    function checkoutTable(tableId) {
        if(!confirm("Settle Bill and Free Table?")) return;
        fetch(`/checkout/${tableId}/`)
        .then(res => res.json())
        .then(data => location.reload());
    }

    // 2. TAKEAWAY SETTLEMENT
    function settleOrder(orderId) {
        if(!confirm("Collect Cash and Close Order #" + orderId + "?")) return;

        fetch(`/settle-order/${orderId}/`)
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                location.reload();
            } else {
                alert("Error: " + data.message);
            }
        });
    }

    // 3. CANCEL / VOID ORDER (NEW)
    function cancelOrder(orderId) {
        if(confirm("DANGER: Void this order? This will remove it from active sales.")) {
            fetch(`/cancel-order/${orderId}/`)
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    location.reload();
                } else {
                    alert("Error: " + data.message);
                }
            });
        }
    }
</script>
<script>
    // Auto-Refresh every 5 seconds to show live table status
    setTimeout(function(){
       window.location.reload();
    }, 5000);
</script>
{% endblock %}
